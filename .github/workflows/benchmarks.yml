name: Benchmarks

on:
  push:
    branches: [main]
  pull_request:
    paths:
      - "**.go"
      - "go.mod"
      - "go.sum"
      - ".github/workflows/benchmarks.yml"

permissions:
  contents: read
  pull-requests: write

jobs:
  # ─────────────────────────────────────────────────────────────────────────
  # Benchmark - Run performance benchmarks with regression detection
  # ─────────────────────────────────────────────────────────────────────────
  benchmark:
    name: Performance Benchmarks
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3
        with:
          install: true
          cache: true
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Run benchmarks
        timeout-minutes: 5
        continue-on-error: true
        run: |
          # Run focused benchmarks excluding slow parser tests that generate large files
          # Use -count=1 for CI speed, -benchtime=1s for consistent results
          go test -bench=. -run=^$ -benchmem -count=1 -benchtime=1s -timeout 4m \
            ./internal/converter/... \
            ./internal/pool/... \
            ./internal/log/... \
            ./cmd/... \
            2>&1 | grep -v "^opnDossier version" | tee benchmark-results.txt

          echo ""
          echo "Note: Parser and processor benchmarks excluded from CI (run locally with 'just bench')"

      - name: Download baseline (main branch)
        if: github.event_name == 'pull_request'
        uses: actions/cache/restore@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: baseline-benchmark.txt
          key: benchmark-baseline-${{ github.base_ref }}
          restore-keys: |
            benchmark-baseline-main

      - name: Compare benchmarks
        if: github.event_name == 'pull_request' && hashFiles('baseline-benchmark.txt') != ''
        id: benchmark-compare
        run: |
          # Install benchstat for comparison
          go install golang.org/x/perf/cmd/benchstat@latest

          # Run comparison and write to file
          {
            echo "## Benchmark Comparison"
            echo ""
            echo "Comparing PR benchmarks against baseline (main branch):"
            echo ""
            echo '```'
            benchstat baseline-benchmark.txt benchmark-results.txt 2>&1 || true
            echo '```'
          } > comparison.md

          # Check for significant regressions (>20% slower)
          if benchstat baseline-benchmark.txt benchmark-results.txt 2>/dev/null | grep -E '\+[2-9][0-9]\.[0-9]+%|\+[1-9][0-9][0-9]+\.[0-9]+%' > /dev/null; then
            {
              echo ""
              echo "⚠️ **Warning**: Some benchmarks show >20% regression. Please review."
            } >> comparison.md
            echo "regression=true" >> "$GITHUB_OUTPUT"
          else
            {
              echo ""
              echo "✅ No significant performance regressions detected."
            } >> comparison.md
            echo "regression=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Post benchmark comparison as PR comment
        if: github.event_name == 'pull_request' && hashFiles('comparison.md') != ''
        uses: actions/github-script@ed597411d8f924073f98dfc5c65a23a2325f34cd # v8
        with:
          script: |
            const fs = require('fs');
            const comparison = fs.readFileSync('comparison.md', 'utf8');

            // Find existing benchmark comment
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            const botComment = comments.find(comment =>
              comment.user.type === 'Bot' &&
              comment.body.includes('## Benchmark Comparison')
            );

            const body = comparison;

            if (botComment) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: botComment.id,
                body: body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: body,
              });
            }

      - name: Save baseline (main branch only)
        if: github.ref == 'refs/heads/main'
        uses: actions/cache/save@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v5
        with:
          path: benchmark-results.txt
          key: benchmark-baseline-main-${{ github.sha }}

      - name: Upload benchmark results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: benchmark-results
          path: |
            benchmark-results.txt
            comparison.md
          retention-days: 30
          if-no-files-found: ignore

  # ─────────────────────────────────────────────────────────────────────────
  # Startup Time - Verify CLI startup performance
  # ─────────────────────────────────────────────────────────────────────────
  startup-time:
    name: Startup Time Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - uses: jdx/mise-action@6d1e696aa24c1aa1bcc1adea0212707c71ab78a8 # v3
        with:
          install: true
          cache: true
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Build release binary
        run: |
          CGO_ENABLED=0 go build -trimpath -ldflags="-s -w" -o opndossier main.go

      - name: Measure startup time
        run: |
          # Warm up (use _ to indicate unused variable)
          for _ in {1..5}; do ./opndossier version > /dev/null 2>&1; done

          # Capture version command time
          version_time=$( { time ./opndossier version > /dev/null 2>&1; } 2>&1 )

          # Capture help command time
          help_time=$( { time ./opndossier --help > /dev/null 2>&1; } 2>&1 )

          # Capture startup benchmarks
          bench_output=$(go test -bench=BenchmarkStartup -run=^$ -benchmem ./cmd/... 2>&1)

          # Write all results to file
          {
            echo "## Startup Time Measurements"
            echo ""
            echo "### Version Command"
            echo '```'
            echo "$version_time"
            echo '```'
            echo ""
            echo "### Help Command"
            echo '```'
            echo "$help_time"
            echo '```'
            echo ""
            echo "### Startup Benchmarks"
            echo '```'
            echo "$bench_output"
            echo '```'
          } > startup-results.md

      - name: Upload startup results
        uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
        with:
          name: startup-results
          path: startup-results.md
          retention-days: 30
